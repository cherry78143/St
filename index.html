<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XDARK Chat — Web</title>
<!-- Simple modern styles -->
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
    --radius:14px; color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,#020617 0%, #071021 100%); color:#e6eef6;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{
    max-width:1100px; margin:20px auto; display:grid; grid-template-columns:320px 1fr; gap:18px;
    padding:18px;
  }
  @media (max-width:900px){ .app{ grid-template-columns: 1fr; padding:12px } .left{order:2} .right{order:1} }
  .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);}
  .left{display:flex; flex-direction:column; gap:12px}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:44px; height:44px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#7c3aed); display:flex;align-items:center;justify-content:center;font-weight:700}
  h1{margin:0;font-size:18px}
  .search{display:flex; gap:8px}
  input,button,textarea{font:inherit}
  .search input{flex:1;padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:inherit}
  .user-row{display:flex; align-items:center; gap:10px}
  .avatar{width:44px;height:44px;border-radius:50%;background:#0b1220;display:flex;align-items:center;justify-content:center}
  .rooms{display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:420px;padding-right:6px}
  .room{padding:10px;border-radius:10px;cursor:pointer;display:flex;gap:10px;align-items:center}
  .room:hover{background:rgba(255,255,255,0.02)}
  .active{background:linear-gradient(90deg, rgba(6,182,212,0.08), rgba(124,58,237,0.06));box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
  .right{display:flex;flex-direction:column;gap:10px}
  .messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:70%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03)}
  .me{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#7c3aed);color:#021018}
  .input-area{display:flex;gap:8px;padding:10px}
  .input-area input{flex:1;padding:12px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
  .btn{background:var(--accent); border:none;color:#021018;padding:10px 14px;border-radius:12px;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center}
  .video-wrap{display:flex;gap:8px;align-items:center}
  video{background:black;border-radius:12px;max-width:100%}
  footer.small{opacity:0.7;text-align:center;padding:6px}
  /* modal */
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:999}
  .modal .card{width:360px}
  .link{color:var(--accent);cursor:pointer}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
  .muted{color:var(--muted)}
  .file-preview{max-width:150px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);overflow:hidden}
</style>
</head>
<body>
<div class="app">
  <!-- LEFT: rooms & profile -->
  <div class="left">
    <div class="card">
      <div class="brand">
        <div class="logo">XD</div>
        <div>
          <h1>XDARK Chat</h1>
          <div class="small muted">Realtime chat • Voice & Video</div>
        </div>
      </div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,0.02);margin:12px 0" />
      <div class="user-row">
        <div class="avatar" id="userAvatar">U</div>
        <div style="flex:1">
          <div id="displayName" class="small">Not signed in</div>
          <div class="small muted" id="userEmail">—</div>
        </div>
        <div>
          <button id="btnSignOut" class="btn" style="display:none">Sign out</button>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="search">
        <input id="roomNameInput" placeholder="Create or join room (username)" />
        <button id="btnCreateRoom" class="btn">Open</button>
      </div>
      <div style="height:12px"></div>
      <div class="small muted">Rooms</div>
      <div class="rooms card" id="roomsList" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small muted">Account</div>
        <div class="small muted">Auth</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="openAuth" class="btn">Sign in / Up</button>
        <button id="openProfile" class="btn" style="background:#334155">Profile</button>
      </div>
      <div style="height:12px"></div>
      <div class="small muted">Call demo</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="startCallBtn" class="btn" title="Start video call">Video</button>
        <button id="startAudioBtn" class="btn" title="Start voice only">Voice</button>
      </div>
    </div>

    <footer class="small muted" style="text-align:center">
      Built with Firebase • <span id="status">offline</span>
    </footer>
  </div>

  <!-- RIGHT: chat & calls -->
  <div class="right">
    <div class="card" style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong id="roomTitle">Welcome</strong>
          <div class="small muted" id="roomSubtitle">Select or create a room</div>
        </div>
        <div class="controls">
          <input type="file" id="fileInput" style="display:none" />
          <button id="attachBtn" class="btn" style="background:#334155">Attach</button>
          <button id="btnCall" class="btn">Call</button>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input id="messageInput" placeholder="Type a message..." />
        <button id="sendBtn" class="btn">Send</button>
      </div>
    </div>

    <!-- video area -->
    <div class="card" id="callPanel" style="display:none;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong id="callTitle">Call</strong></div>
        <div>
          <button id="hangupBtn" class="btn" style="background:#ef4444">Hang up</button>
        </div>
      </div>
      <div class="video-wrap">
        <div style="flex:1">
          <div class="small muted">You</div>
          <video id="localVideo" autoplay muted playsinline style="height:240px;width:100%;object-fit:cover;border-radius:10px;background:#000"></video>
        </div>
        <div style="flex:1">
          <div class="small muted">Remote</div>
          <video id="remoteVideo" autoplay playsinline style="height:240px;width:100%;object-fit:cover;border-radius:10px;background:#000"></video>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authModal" class="modal" style="display:none">
  <div class="card">
    <div class="topbar">
      <div><strong>Sign in / Sign up</strong></div>
      <div><span class="small muted">Secure • Firebase</span></div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="authEmail" placeholder="Email" />
      <input id="authPassword" type="password" placeholder="Password" />
      <div style="display:flex;gap:8px">
        <button id="emailSignIn" class="btn">Sign In</button>
        <button id="emailSignUp" class="btn" style="background:#334155">Sign Up</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="googleSignIn" class="btn" style="background:#fff;color:#021018">Sign in with Google</button>
        <button id="forgotBtn" class="btn" style="background:#0ea5a4">Forgot</button>
      </div>
      <div class="small muted">Or enter a username to create or join a room above</div>
      <div style="display:flex;justify-content:flex-end;margin-top:6px">
        <button id="closeAuth" class="btn" style="background:#334155">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profileModal" class="modal" style="display:none">
  <div class="card">
    <div class="topbar"><strong>Profile</strong><span class="small muted">Update display name</span></div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="profileName" placeholder="Display name" />
      <input id="profilePhotoURL" placeholder="Avatar image URL (optional)" />
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="saveProfile" class="btn">Save</button>
        <button id="closeProfile" class="btn" style="background:#334155">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs (compat for easier code in single file) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

<script>
/* ---------------------------
   Firebase configuration
   (from the JSON you provided)
   --------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCj1bt3rP1XcIbSfTUFhrkUrm9Li8ZB85A",
  authDomain: "xdark-8b6b0.firebaseapp.com",
  databaseURL: "https://xdark-8b6b0-default-rtdb.firebaseio.com",
  projectId: "xdark-8b6b0",
  storageBucket: "xdark-8b6b0.appspot.com",
  messagingSenderId: "12349294669",
  appId: "1:12349294669:web:836be375f5a28235823404"
};

/* Initialize Firebase */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

/* UI references */
const statusEl = document.getElementById('status');
const displayNameEl = document.getElementById('displayName');
const userEmailEl = document.getElementById('userEmail');
const userAvatar = document.getElementById('userAvatar');
const btnSignOut = document.getElementById('btnSignOut');
const openAuth = document.getElementById('openAuth');
const authModal = document.getElementById('authModal');
const openProfile = document.getElementById('openProfile');
const profileModal = document.getElementById('profileModal');
const profileName = document.getElementById('profileName');
const profilePhotoURL = document.getElementById('profilePhotoURL');
const saveProfile = document.getElementById('saveProfile');
const closeProfile = document.getElementById('closeProfile');

const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const emailSignIn = document.getElementById('emailSignIn');
const emailSignUp = document.getElementById('emailSignUp');
const googleSignIn = document.getElementById('googleSignIn');
const forgotBtn = document.getElementById('forgotBtn');
const closeAuth = document.getElementById('closeAuth');

const roomNameInput = document.getElementById('roomNameInput');
const btnCreateRoom = document.getElementById('btnCreateRoom');
const roomsList = document.getElementById('roomsList');

const roomTitle = document.getElementById('roomTitle');
const roomSubtitle = document.getElementById('roomSubtitle');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const attachBtn = document.getElementById('attachBtn');
const fileInput = document.getElementById('fileInput');

const startCallBtn = document.getElementById('startCallBtn');
const startAudioBtn = document.getElementById('startAudioBtn');
const callPanel = document.getElementById('callPanel');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const hangupBtn = document.getElementById('hangupBtn');
const btnCall = document.getElementById('btnCall');

let currentUser = null;
let currentRoom = null;
let roomsSnapshot = {};
let messagesRef = null;

/* ---------------- Authentication ---------------- */
auth.onAuthStateChanged(user => {
  currentUser = user;
  if (user) {
    displayNameEl.textContent = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
    userEmailEl.textContent = user.email || 'No email';
    userAvatar.textContent = (user.displayName || 'U').slice(0,1).toUpperCase();
    btnSignOut.style.display = 'inline-block';
    statusEl.textContent = 'online';
  } else {
    displayNameEl.textContent = 'Not signed in';
    userEmailEl.textContent = '—';
    userAvatar.textContent = 'U';
    btnSignOut.style.display = 'none';
    statusEl.textContent = 'offline';
  }
});

/* UI events */
openAuth.addEventListener('click', ()=> authModal.style.display = 'flex');
closeAuth.addEventListener('click', ()=> authModal.style.display = 'none');
openProfile.addEventListener('click', ()=> {
  if (!currentUser) return alert('Sign in first');
  profileModal.style.display = 'flex';
  profileName.value = currentUser.displayName || '';
  profilePhotoURL.value = currentUser.photoURL || '';
});
closeProfile.addEventListener('click', ()=> profileModal.style.display = 'none');
btnSignOut.addEventListener('click', ()=> auth.signOut());

emailSignUp.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pass = authPassword.value;
  if (!email || !pass) return alert('Provide email and password');
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: email.split('@')[0] });
    alert('Account created');
    authModal.style.display = 'none';
  } catch(e){ alert('Sign up error: '+e.message) }
});
emailSignIn.addEventListener('click', async ()=>{
  const email = authEmail.value.trim(); const pass = authPassword.value;
  if (!email || !pass) return alert('Provide email and password');
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    authModal.style.display = 'none';
  } catch(e){ alert('Sign in error: '+e.message) }
});
googleSignIn.addEventListener('click', async ()=>{
  // Google sign-in requires you to add domain in Firebase console
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
    authModal.style.display = 'none';
  } catch(e){ alert('Google sign in error: '+e.message) }
});
forgotBtn.addEventListener('click', async ()=>{
  const email = authEmail.value.trim();
  if (!email) return alert('Enter your email to receive reset link');
  try {
    await auth.sendPasswordResetEmail(email);
    alert('Password reset email sent');
  } catch(e){ alert('Error: '+e.message) }
});

saveProfile.addEventListener('click', async ()=>{
  const name = profileName.value.trim();
  const photo = profilePhotoURL.value.trim();
  if (!currentUser) return alert('Not signed in');
  try {
    await currentUser.updateProfile({ displayName: name || currentUser.displayName, photoURL: photo || null });
    alert('Profile updated');
    profileModal.style.display = 'none';
    displayNameEl.textContent = currentUser.displayName || currentUser.email.split('@')[0];
    userAvatar.textContent = (currentUser.displayName||'U').slice(0,1).toUpperCase();
  } catch(e){ alert('Update error: '+e.message) }
});

/* ---------------- Rooms listing ---------------- */
function addRoomToList(name){
  if (roomsSnapshot[name]) return;
  const div = document.createElement('div');
  div.className = 'room';
  div.id = 'room_'+name;
  div.innerHTML = `<div style="width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center">${name[0].toUpperCase()}</div>
    <div style="flex:1"><strong>${name}</strong><div class="small muted">Chat room</div></div>`;
  div.addEventListener('click', ()=> openRoom(name));
  roomsList.appendChild(div);
  roomsSnapshot[name] = div;
}

/* For demo: list top active rooms by reading a "rooms" node */
const roomsRef = db.ref('rooms');
roomsRef.limitToLast(50).on('value', snap=>{
  roomsList.innerHTML = '';
  roomsSnapshot = {};
  const val = snap.val() || {};
  Object.keys(val).reverse().forEach(k => addRoomToList(k));
});

/* ---------------- Chat: join/create room ---------------- */
btnCreateRoom.addEventListener('click', ()=> {
  const name = roomNameInput.value.trim();
  if (!name) return alert('Enter a room name (username or group)');
  openRoom(name);
});

async function openRoom(name){
  if (!name) return;
  // mark room exists
  await db.ref('rooms/'+name).set({ lastSeen: Date.now() });
  // change UI
  currentRoom = name;
  roomTitle.textContent = name;
  roomSubtitle.textContent = 'Realtime chat';
  // highlight
  document.querySelectorAll('.room').forEach(r=>r.classList.remove('active'));
  const el = document.getElementById('room_'+name);
  if (el) el.classList.add('active');
  // attach messages
  if (messagesRef) messagesRef.off();
  messagesEl.innerHTML = '';
  messagesRef = db.ref('messages/'+name);
  messagesRef.on('child_added', snap => {
    const m = snap.val();
    showMessage(m);
  });
  // scroll to bottom after small delay
  setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 150);
}

/* ---------------- Show messages ---------------- */
function showMessage(m){
  const div = document.createElement('div');
  div.className = 'msg';
  if (currentUser && m.uid === currentUser.uid) div.classList.add('me');
  if (m.type === 'text'){
    div.innerHTML = `<div style="font-size:13px;color:var(--muted)">${escapeHtml(m.name||'User')}</div><div style="margin-top:6px">${escapeHtml(m.text)}</div><div class="small muted" style="margin-top:6px">${new Date(m.ts).toLocaleTimeString()}</div>`;
  } else if (m.type === 'image'){
    div.innerHTML = `<div style="font-size:13px;color:var(--muted)">${escapeHtml(m.name||'User')}</div><img src="${m.url}" class="file-preview" /><div class="small muted">${new Date(m.ts).toLocaleTimeString()}</div>`;
  } else if (m.type === 'system'){
    div.innerHTML = `<div class="small muted">${escapeHtml(m.text)}</div>`;
    div.style.textAlign = 'center';
  }
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ---------------- Sending messages & attachments ---------------- */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

async function sendMessage(){
  if (!currentRoom) return alert('Open a room first');
  const text = messageInput.value.trim();
  if (!text) return;
  const m = { type:'text', text, uid: currentUser? currentUser.uid:null, name: currentUser? currentUser.displayName: 'Guest', ts: Date.now() };
  await db.ref('messages/'+currentRoom).push(m);
  messageInput.value = '';
}

/* Attach file upload */
attachBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  if (!currentRoom) return alert('Open a room first');
  const id = Date.now() + '_' + file.name;
  const path = `uploads/${currentRoom}/${id}`;
  const uploadTask = storage.ref(path).put(file);
  uploadTask.on('state_changed', snap => {}, async err => {
    alert('Upload error: '+err.message);
  }, async ()=>{
    const url = await storage.ref(path).getDownloadURL();
    const m = { type:'image', url, uid: currentUser? currentUser.uid:null, name: currentUser? currentUser.displayName:'Guest', ts: Date.now() };
    await db.ref('messages/'+currentRoom).push(m);
    fileInput.value = '';
  });
});

/* ----------------- Simple WebRTC via Realtime DB signalling -----------------
  - To call: create an entry in /calls/{room}/{callerId}
  - Offer/answer and ICE candidates exchanged under that node.
  - This is a simplistic approach for demo; for production use a TURN server.
------------------------------------------------------------------------- */

let pc = null;
let localStream = null;
let remoteStream = null;
let callRef = null;
let callId = null;
const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }; // no TURN here - may fail on restrictive networks

startCallBtn.addEventListener('click', ()=> startCall({video:true}));
startAudioBtn.addEventListener('click', ()=> startCall({video:false}));
btnCall.addEventListener('click', ()=> {
  if (!currentRoom) return alert('Open a room to call');
  startCall({video:true});
});

hangupBtn.addEventListener('click', endCall);

async function startCall({video}){
  if (!currentRoom) return alert('Open a room first');
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: video ? {width:640, height:480} : false });
  } catch(e){ return alert('Media error: '+e.message); }
  // show local
  localVideo.srcObject = localStream;
  // create RTCPeerConnection
  pc = new RTCPeerConnection(servers);
  remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;
  // add tracks
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  // ontrack
  pc.ontrack = event => {
    event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
  };
  // ICE candidates -> DB
  pc.onicecandidate = event => {
    if (event.candidate && callRef) {
      callRef.child('candidates').push({ candidate: event.candidate.toJSON(), from: auth.currentUser?auth.currentUser.uid:'anon' });
    }
  };

  // create call node
  callRef = db.ref('calls/'+currentRoom).push();
  callId = callRef.key;
  // create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await callRef.set({ offer: offer.toJSON(), from: auth.currentUser?auth.currentUser.uid:'anon', ts: Date.now() });

  callPanel.style.display = 'flex';
  callTitle.innerText = 'Calling: '+currentRoom;

  // listen for answer
  callRef.on('value', snap => {
    const val = snap.val();
    if (!val) return;
    if (val.answer && !pc.remoteDescription) {
      const answerDesc = new RTCSessionDescription(val.answer);
      pc.setRemoteDescription(answerDesc).catch(e=>console.warn(e));
    }
  });
  // listen for remote ICE
  callRef.child('candidates').on('child_added', snap => {
    const c = snap.val();
    if (c && c.candidate) {
      try {
        pc.addIceCandidate(new RTCIceCandidate(c.candidate));
      } catch(e){ console.warn('ICE add err', e); }
    }
  });

  // Also create a listener so someone else can answer (we're caller here)
  /* Note: In this simple demo both parties that open the same room can be caller or callee.
     To answer calls we also watch `calls/{room}` and if there's an existing offer and we didn't originate it, we answer below. */
}

/* Listen for incoming calls and auto-answer when we join a room (simple logic) */
db.ref('calls').on('child_added', snapRoot => {
  // snapRoot.key -> roomId; snapRoot.val() -> object of call nodes
  const room = snapRoot.key;
  // If this room is currently opened and there's a call we didn't create, answer it
  if (room !== currentRoom) return;
  snapRoot.forEach(node=>{
    const callNodeKey = node.key;
    const callData = node.val();
    if (!callData || !callData.offer) return;
    // If callRef exists and we're the same caller, ignore.
    if (callRef && callRef.key === callNodeKey) return;
    // Answer as callee
    answerCall(room, callNodeKey, callData);
  });
});

async function answerCall(room, callKey, callData){
  try {
    // create peerconnection & streams
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true }).catch(()=>navigator.mediaDevices.getUserMedia({audio:true,video:false}));
  } catch(e){ console.warn('Could not get media', e); return; }
  localVideo.srcObject = localStream;
  pc = new RTCPeerConnection(servers);
  remoteStream = new MediaStream();
  remoteVideo.srcObject = remoteStream;
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  pc.ontrack = event => event.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t));
  pc.onicecandidate = event => {
    if (event.candidate) {
      db.ref('calls/'+room+'/'+callKey+'/candidates').push({ candidate: event.candidate.toJSON(), from: auth.currentUser?auth.currentUser.uid:'anon' });
    }
  };
  // set remote desc from offer
  const offerDesc = new RTCSessionDescription(callData.offer);
  await pc.setRemoteDescription(offerDesc);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  // write answer back
  await db.ref('calls/'+room+'/'+callKey).update({ answer: answer.toJSON(), answeredBy: auth.currentUser?auth.currentUser.uid:'anon' });
  // subscribe to candidates
  db.ref('calls/'+room+'/'+callKey+'/candidates').on('child_added', snap => {
    const c = snap.val();
    if (c && c.candidate) pc.addIceCandidate(new RTCIceCandidate(c.candidate)).catch(e=>console.warn(e));
  });

  callPanel.style.display = 'flex';
  callTitle.innerText = 'In call: '+room;
}

/* hang up */
function endCall(){
  if (pc) { pc.close(); pc = null; }
  if (localStream) { localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
  if (remoteStream) { remoteStream.getTracks().forEach(t=>t.stop()); remoteStream = null; }
  if (callRef) {
    callRef.remove().catch(()=>{});
    callRef.off();
    callRef = null;
  }
  callPanel.style.display = 'none';
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
}

/* Auto cleanup: remove stale call nodes older than certain time (optional) */
setInterval(async ()=>{
  const calls = await db.ref('calls').once('value');
  calls.forEach(roomSnap=>{
    roomSnap.forEach(callSnap=>{
      const v = callSnap.val();
      if (v && v.ts && Date.now() - v.ts > 1000*60*30) callSnap.ref.remove();
    });
  });
}, 1000*60*10);

/* Basic presence and housekeeping */
window.addEventListener('beforeunload', ()=> {
  // optional: set offline
});

/* small helper: display system messages as well */
function systemMessage(text){
  if (!currentRoom) return;
  db.ref('messages/'+currentRoom).push({type:'system', text, ts: Date.now()});
}

/* Escape: provide helpful hint for the user */
roomsList.addEventListener('dblclick', (e)=> {
  alert('Tip: Double-clicked rooms are quick to join. Use create/join above to enter a room.');
});

/* Simple rules for demo: ensure DB rules allow reads/writes to /messages and /calls for authenticated users.
   Production: tighten rules! */

/* DONE */
console.log('App initialized');
</script>

</body>
</html>
